# Item 48. 스트림 병렬화는 주의해서 적용하라

자바는 동시성 프로그래밍이 뛰어나다. (스레드, 포크-조인, 병렬 스트림)

동시성 프로그래밍엔 안정성과 응답 가능 상태 유지가 가장 중요하다.

스트림 파이프라인을 병렬화 하려면 parallel을 사용하면 되지만, 몇몇 조건이 더 있다.

- 데이터 소스가 Stream.iterate거나, limit를 쓰면 성능 개선을 기대할 수 없다.
- 가변 축소 스트림은 적합하지 않다.

스트림 병렬 성능을 빠르게 하려면

- 스트림 소스를 나눌 수 있어야 한다. (spliterator를 통해 가능한 자료구조가 있음 ArrayList, HashMap등)
- 참조 지역성 또한 중요하다. 데이터를 즉각적으로 가져오냐, 가져오는동안 기다리냐의 차이
- 종단 연산 방식이 파이프 라인의 작업에서 비중이 작을 수록 성능이 빨라진다. (합치는 작업은 병렬 불가)

주의점

- 스트림 병렬화를 잘못하면 성능 뿐만 아니라 결과값이 달라지기도 한다.
    - 결합 법칙을 만족하며 간섭받지 않고, stateless 여야 한다.
- 계산에 문제가 없더라도, 결과값의 순서가 뒤죽박죽일 수 있는데 이를 재정렬해야한다.
- 위 조건들을 모두 지키게 된다면 올바른 병렬 스트림의 사용이지만, 성능이 더 느려질 수 있다.
    - 스트림 안의 원소수와 수행하는 코드 줄 수를 곱했을때 수십만이 되면 성능 향상을 맛볼 수 있다.

ETC

- SplittableRandom 인스턴스 : 병렬화시 성능 선형증가
- ThreadLocalRandom : 단일 스레드에서 쓰고자 만들어져 엄청 빠르진 않다.
- Random : 동기화되어 병렬처리하면 최악의 성능

### 마무리

병렬 처리는 아무때나 하지 말고 확실한 상황에서만 진행하자.
